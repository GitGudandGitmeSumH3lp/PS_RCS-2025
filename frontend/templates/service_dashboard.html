<!-- PS_RCS_PROJECT
Copyright (c) 2026. All rights reserved.
File: service_dashboard.html
Description: Main service dashboard with linear-style grid layout and modal interactions.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PS-RCS Dashboard v{{ app_version }}</title>
  <link rel="stylesheet" href="/static/css/service_theme.css">
  <link rel="stylesheet" href="/static/css/ocr-panel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <style>
    /* Additional styles for recent scans card */
    .scan-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.8rem;
    }
    .scan-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-light, #333);
      cursor: pointer;
      transition: background-color 0.1s ease;
    }
    .scan-item:hover {
      background-color: var(--bg-hover, rgba(255,255,255,0.05));
    }
    .scan-item .confidence-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .confidence-dot.high { background: #10B981; }
    .confidence-dot.medium { background: #F59E0B; }
    .confidence-dot.low { background: #EF4444; }
    .scan-tracking { flex: 2; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .scan-buyer { flex: 3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary, #aaa); }
    .scan-time { flex: 1; font-size: 0.7rem; color: var(--text-secondary, #aaa); }
    .scan-conf { flex: 0.5; text-align: right; font-family: monospace; }
    .empty-message { color: var(--text-secondary, #aaa); padding: 0.5rem 0; }
    [data-theme="light"] .scan-item { border-bottom-color: #ddd; }
  </style>
</head>
<body data-theme="dark">
  
  <header id="global-status-bar" class="status-bar" role="banner">
    <div id="connection-indicator" class="status-badge" data-connected="false" role="status" aria-label="System Connection Status">CONN: OFFLINE</div>
    <div id="battery-display" class="status-metric" data-voltage="0.0" role="status" aria-label="Battery Voltage">0.0V</div>
    <button id="theme-toggle" class="icon-button" aria-label="Toggle theme">ğŸŒ“</button>
  </header>

  <main id="dashboard-grid" class="grid-layout" role="main">
    
    <!-- Vision System Card -->
    <article id="card-vision-preview" class="linear-card clickable" role="button" tabindex="0" aria-label="Vision system preview - Click to open camera stream">
      <header class="card-header">
        <div class="icon-container" aria-hidden="true">
          <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 10L20.576 8.283C20.8586 8.097 21.2029 7.997 21.553 8H22C23.1046 8 24 8.89543 24 10V18C24 19.1046 23.1046 20 22 20H2C0.89543 20 0 19.1046 0 18V10C0 8.89543 0.89543 8 2 8H2.447C2.7971 7.997 3.1414 8.097 3.424 8.283L6 10M15 13C15 14.6569 13.6569 16 12 16C10.3431 16 9 14.6569 9 13C9 11.3431 10.3431 10 12 10C13.6569 10 15 11.3431 15 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3 class="card-title">Vision System</h3>
        <div class="status-indicator" data-status="offline" aria-live="polite">
          <span class="status-dot"></span>
          <span class="status-text">Offline</span>
        </div>
      </header>
      <div class="card-body">
        <div id="camera-placeholder" class="preview-placeholder">
          <svg class="placeholder-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 10L20.576 8.283C20.8586 8.097 21.2029 7.997 21.553 8H22C23.1046 8 24 8.89543 24 10V18C24 19.1046 23.1046 20 22 20H2C0.89543 20 0 19.1046 0 18V10C0 8.89543 0.89543 8 2 8H2.447C2.7971 7.997 3.1414 8.097 3.424 8.283L6 10M15 13C15 14.6569 13.6569 16 12 16C10.3431 16 9 14.6569 9 13C9 11.3431 10.3431 10 12 10C13.6569 10 15 11.3431 15 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div id="live-stream-container" class="hidden" style="position:relative;">
          <img id="live-stream" src="" alt="Live camera feed" crossorigin="anonymous" style="width:100%;border-radius:4px;">
          <button id="stop-camera-btn" class="btn-ghost" aria-label="Stop camera stream" style="position:absolute;top:4px;right:4px;">â¹ Stop</button>
        </div>
        <div class="card-hover-overlay">
          <span>Click to open</span>
        </div>
      </div>
    </article>

    <!-- Motor Control Card -->
    <article id="control-card" class="linear-card clickable" role="button" tabindex="0" aria-label="Motor control panel - Click to open controls">
      <header class="card-header">
        <div class="icon-container" aria-hidden="true">
          <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M4 21V14M4 10V3M12 21V12M12 8V3M20 21V16M20 12V3M1 14H7M9 8H15M17 16H23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3 class="card-title">Motor Control</h3>
        <div class="status-indicator" data-status="offline" aria-live="polite">
          <span class="status-dot"></span>
          <span class="status-text">Offline</span>
        </div>
      </header>
      <div class="card-body">
        <div class="preview-placeholder">
          <div class="preview-text">Control panel</div>
        </div>
      </div>
    </article>

    <!-- OCR Scanner Card -->
    <article id="ocr-scanner-card" class="linear-card clickable" role="button" tabindex="0" aria-label="OCR Scanner - Multi-source document scanning">
        <header class="card-header">
            <div class="icon-container" aria-hidden="true">
                <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <h3 class="card-title">OCR Scanner</h3>
            <div class="status-indicator" data-status="offline" aria-live="polite">
                <span class="status-dot"></span>
                <span class="status-text">Ready</span>
            </div>
        </header>
        <div class="card-body">
            <div class="preview-placeholder">
                <svg class="placeholder-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="card-hover-overlay">
                <span>Click to scan</span>
            </div>
        </div>
    </article>

    <!-- LiDAR Sensor Card -->
    <article id="card-lidar" class="linear-card clickable" role="button" tabindex="0" aria-label="LiDAR sensor - Click to open visualization">
      <header class="card-header">
        <div class="icon-container" aria-hidden="true">
          <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="2" fill="currentColor"/>
            <path d="M12 5 L12 2 M12 22 L12 19 M5 12 L2 12 M22 12 L19 12 M7.05 7.05 L4.93 4.93 M19.07 19.07 L16.95 16.95 M19.07 4.93 L16.95 7.05 M7.05 16.95 L4.93 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3 class="card-title">LiDAR Sensor</h3>
        <div class="status-indicator" data-status="offline" aria-live="polite">
          <span class="status-dot"></span>
          <span class="status-text">Offline</span>
        </div>
      </header>
      <div class="card-body">
        <div class="preview-placeholder">
          <svg class="placeholder-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
            <circle cx="12" cy="12" r="2" fill="currentColor"/>
            <path d="M12 4 L12 1 M12 23 L12 20 M4 12 L1 12 M23 12 L20 12" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <div class="card-hover-overlay">
          <span>Click to open</span>
        </div>
      </div>
    </article>

    <!-- NEW: Recent OCR Scans Card -->
    <article id="card-recent-scans" class="linear-card">
      <header class="card-header">
        <div class="icon-container" aria-hidden="true">
          <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <h3 class="card-title">Recent OCR Scans</h3>
      </header>
      <div id="recent-scans-list" class="card-body">
        <!-- Dynamically populated by dashboard-core.js -->
        <p class="empty-message">Loading...</p>
      </div>
    </article>

    <!-- Last Scan Results Card (kept for backward compatibility) -->
    <article id="scan-results-card" class="linear-card hidden" role="region" aria-label="Last scan results" aria-live="polite">
      <header class="card-header">
        <div class="icon-container" aria-hidden="true">
          <svg class="card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <h3 class="card-title">Last Scan</h3>
      </header>
      <div class="card-body">
        <div class="scan-data">
          <p class="text-sm"><strong>Tracking ID:</strong> <span id="tracking-id">-</span></p>
          <p class="text-sm"><strong>Order ID:</strong> <span id="order-id">-</span></p>
          <p class="text-sm"><strong>RTS Code:</strong> <span id="rts-code">-</span></p>
          <p class="text-sm"><strong>District:</strong> <span id="district">-</span></p>
          <p class="text-sm"><strong>Confidence:</strong> <span id="confidence">-</span></p>
          <p class="text-sm"><strong>Time:</strong> <span id="scan-time">-</span></p>
        </div>
      </div>
    </article>

  </main>

  <!-- Vision Modal -->
  <dialog id="modal-vision" class="linear-modal" aria-labelledby="modal-vision-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <header class="modal-header">
        <h2 id="modal-vision-title" class="modal-title">Vision Panel</h2>
        <div class="modal-actions">
          <button id="btn-vision-scan" class="btn-primary" aria-label="Scan label from camera feed" disabled>
            <span class="btn-text">Scan Label</span>
            <span class="btn-spinner hidden" aria-hidden="true"></span>
          </button>
          <button id="btn-vision-close" class="btn-ghost btn-icon-only" aria-label="Close vision panel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </header>
      <div class="modal-body">
        <div class="stream-container">
          <img id="vision-stream" class="stream-image" data-src="/api/vision/stream" alt="Live camera feed" crossorigin="anonymous"/>
          <div class="error-state hidden" aria-live="assertive">
            <div class="error-icon" aria-hidden="true">âš ï¸</div>
            <div class="error-message">Camera stream unavailable</div>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <div class="modal-actions">
            <button id="btn-scan-label" class="btn-primary" aria-label="Scan current frame">
                <span aria-hidden="true">ğŸ”</span> Scan Frame
            </button>
            <button id="btn-capture-photo" class="btn-secondary" aria-label="Save high-res photo">
                <span aria-hidden="true">ğŸ“¸</span> Save Photo
            </button>
        </div>
        <div id="capture-preview" class="capture-preview hidden" aria-live="polite">
            <img id="capture-thumbnail" src="" alt="Captured high-resolution photo">
            <div class="preview-actions">
                <a id="download-link" class="btn-ghost" download aria-label="Download Captured Photo">â†“ Download</a>
                <button id="close-preview" class="btn-ghost btn-icon-only" aria-label="Close Preview">âœ•</button>
            </div>
            <!-- Sharpness diagnostics â€“ populated by JS after capture -->
            <div id="capture-diagnostics" style="display:none;margin-top:0.5rem;padding:0.4rem 0.6rem;border-radius:4px;font-size:0.75rem;border:1px solid var(--border-light,#333);">
              <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:0.3rem;">
                <span>ğŸ“ <strong id="diag-resolution">â€”</strong></span>
                <span>ğŸ”¬ Laplacian: <strong id="diag-sharpness">â€”</strong></span>
                <span>ğŸ“Š FocusFoM: <strong id="diag-fom">â€”</strong></span>
              </div>
              <div id="diag-verdict" style="font-weight:600;"></div>
            </div>
        </div>

        <!-- â”€â”€ Focus Finder Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <!-- Useful when VCM is stuck: move object until FocusFoM peaks,  -->
        <!-- then mark that distance as the fixed working distance.        -->
        <details id="focus-finder-details" style="margin-top:0.75rem;border:1px solid var(--border-light,#333);border-radius:6px;padding:0.5rem 0.75rem;">
          <summary style="cursor:pointer;font-size:0.8rem;font-weight:600;color:var(--text-secondary,#aaa);user-select:none;list-style:none;display:flex;align-items:center;gap:0.5rem;">
            <span id="focus-finder-chevron" style="transition:transform 0.2s;display:inline-block;">â–¶</span>
            ğŸ”¬ Focus Finder <span style="font-weight:400;opacity:0.7;">(move object until bar peaks)</span>
          </summary>

          <div style="margin-top:0.6rem;">
            <!-- FocusFoM bar -->
            <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.4rem;">
              <span style="font-size:0.75rem;color:var(--text-secondary,#aaa);min-width:72px;">FocusFoM</span>
              <div style="flex:1;background:var(--bg-surface,#1e293b);border-radius:4px;height:12px;overflow:hidden;border:1px solid var(--border-light,#333);">
                <div id="focus-fom-bar" style="height:100%;width:0%;background:#3b82f6;border-radius:4px;transition:width 0.15s ease,background 0.15s ease;"></div>
              </div>
              <span id="focus-fom-value" style="font-family:monospace;font-size:0.8rem;min-width:52px;text-align:right;">â€”</span>
            </div>

            <!-- Distance hint row -->
            <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.75rem;color:var(--text-secondary,#aaa);margin-bottom:0.5rem;">
              <span style="min-width:72px;">LP actual</span>
              <span id="focus-lp-value" style="font-family:monospace;">â€”</span>
              <span id="focus-distance-hint" style="margin-left:auto;font-style:italic;"></span>
            </div>

            <!-- Peak tracker -->
            <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.75rem;margin-bottom:0.6rem;">
              <span style="min-width:72px;color:var(--text-secondary,#aaa);">Session peak</span>
              <span id="focus-peak-value" style="font-family:monospace;color:#10b981;font-weight:600;">â€”</span>
              <button id="btn-reset-peak" class="btn-ghost" style="margin-left:auto;font-size:0.7rem;padding:2px 8px;" aria-label="Reset peak">Reset</button>
            </div>

            <!-- Controls -->
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
              <button id="btn-focus-start" class="btn-primary" style="font-size:0.75rem;padding:4px 12px;" aria-label="Start live focus polling">â–¶ Start</button>
              <button id="btn-focus-stop"  class="btn-secondary" style="font-size:0.75rem;padding:4px 12px;" disabled aria-label="Stop focus polling">â¹ Stop</button>
              <button id="btn-focus-mark"  class="btn-ghost" style="font-size:0.75rem;padding:4px 12px;" disabled aria-label="Mark this distance as working distance">ğŸ“Œ Mark Distance</button>
            </div>

            <div id="focus-mark-note" style="display:none;margin-top:0.5rem;padding:0.4rem 0.6rem;background:rgba(16,185,129,0.1);border:1px solid #10b981;border-radius:4px;font-size:0.75rem;color:#10b981;" aria-live="polite"></div>
          </div>
        </details>
        <!-- â”€â”€ /Focus Finder Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

      </footer>
    </div>
  </dialog>

  <script>
  // â”€â”€ Save Photo + Sharpness Diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function () {
    'use strict';

    const btnCapture  = document.getElementById('btn-capture-photo');
    const preview     = document.getElementById('capture-preview');
    const thumbnail   = document.getElementById('capture-thumbnail');
    const dlLink      = document.getElementById('download-link');
    const closeBtn    = document.getElementById('close-preview');
    const diagBox     = document.getElementById('capture-diagnostics');
    const diagRes     = document.getElementById('diag-resolution');
    const diagSharp   = document.getElementById('diag-sharpness');
    const diagFom     = document.getElementById('diag-fom');
    const diagVerdict = document.getElementById('diag-verdict');

    if (!btnCapture) return;   // not on this page

    const VERDICT_COLOURS = {
      'Sharp':  '#10b981',
      'Soft':   '#f59e0b',
      'Blurry': '#ef4444',
    };

    function verdictColour(verdict) {
      for (const [key, colour] of Object.entries(VERDICT_COLOURS)) {
        if (verdict.startsWith(key)) return colour;
      }
      return '#94a3b8';
    }

    btnCapture.addEventListener('click', async () => {
      btnCapture.disabled = true;
      btnCapture.textContent = 'â³ Capturingâ€¦';

      // Hide stale diagnostics
      diagBox.style.display = 'none';
      preview.classList.add('hidden');

      try {
        const res  = await fetch('/api/vision/capture', { method: 'POST' });
        const data = await res.json();

        if (!data.success) {
          if (typeof window.showToast === 'function') {
            window.showToast(data.error || 'Capture failed', 'error');
          }
          return;
        }

        // Show thumbnail
        thumbnail.src      = data.download_url;
        dlLink.href        = data.download_url;
        dlLink.download    = data.download_url.split('/').pop();
        preview.classList.remove('hidden');

        // Show diagnostics if server returned them
        if (data.sharpness !== undefined) {
          diagRes.textContent   = data.resolution   || 'â€”';
          diagSharp.textContent = data.sharpness     != null ? data.sharpness.toLocaleString() : 'â€”';
          diagFom.textContent   = data.focus_fom     != null ? data.focus_fom.toLocaleString() : 'N/A';
          diagVerdict.textContent  = data.verdict    || 'â€”';
          diagVerdict.style.color  = verdictColour(data.verdict || '');
          diagBox.style.display    = 'block';
          // Colour the box border to match verdict
          diagBox.style.borderColor = verdictColour(data.verdict || '');
        }

        if (typeof window.showToast === 'function') {
          const msg = data.verdict
            ? `Photo saved Â· ${data.verdict}`
            : 'Photo saved';
          window.showToast(msg, data.sharpness >= 200 ? 'success' : 'warning');
        }

      } catch (err) {
        if (typeof window.showToast === 'function') {
          window.showToast('Capture request failed', 'error');
        }
      } finally {
        btnCapture.disabled = false;
        btnCapture.innerHTML = '<span aria-hidden="true">ğŸ“¸</span> Save Photo';
      }
    });

    closeBtn.addEventListener('click', () => {
      preview.classList.add('hidden');
      diagBox.style.display = 'none';
    });
  }());
  // â”€â”€ /Save Photo + Sharpness Diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>

  <script>
  // â”€â”€ Focus Finder controller â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function () {
    'use strict';

    const BAR_MAX_FOM = 8000;   // treat 8000 as 100% on the bar (tweak after testing)

    let pollTimer   = null;
    let sessionPeak = 0;

    const elBar      = document.getElementById('focus-fom-bar');
    const elFomVal   = document.getElementById('focus-fom-value');
    const elLpVal    = document.getElementById('focus-lp-value');
    const elDistHint = document.getElementById('focus-distance-hint');
    const elPeak     = document.getElementById('focus-peak-value');
    const elMarkNote = document.getElementById('focus-mark-note');
    const btnStart   = document.getElementById('btn-focus-start');
    const btnStop    = document.getElementById('btn-focus-stop');
    const btnMark    = document.getElementById('btn-focus-mark');
    const btnReset   = document.getElementById('btn-reset-peak');
    const details    = document.getElementById('focus-finder-details');
    const chevron    = document.getElementById('focus-finder-chevron');

    /** Rotate chevron when <details> opens/closes */
    details.addEventListener('toggle', () => {
      chevron.style.transform = details.open ? 'rotate(90deg)' : 'rotate(0deg)';
    });

    /** Poll /api/camera/focus-status and update UI */
    async function poll() {
      try {
        const res  = await fetch('/api/camera/focus-status');
        if (!res.ok) { updateBar(0, null); return; }
        const data = await res.json();

        const fom = data.focus_fom  || 0;
        const lp  = data.lens_position != null ? data.lens_position : null;
        updateBar(fom, lp);
      } catch (_) {
        updateBar(0, null);
      }
    }

    function updateBar(fom, lp) {
      const pct = Math.min(100, Math.round((fom / BAR_MAX_FOM) * 100));

      // Colour: red â†’ amber â†’ green based on pct
      let colour = '#ef4444';
      if (pct >= 60) colour = '#10b981';
      else if (pct >= 30) colour = '#f59e0b';

      elBar.style.width      = pct + '%';
      elBar.style.background = colour;
      elFomVal.textContent   = fom > 0 ? fom.toLocaleString() : 'â€”';

      if (lp !== null) {
        elLpVal.textContent = lp.toFixed(1);
        elDistHint.textContent = lp > 0 ? `â‰ˆ ${Math.round(100 / lp)} cm` : 'âˆ (infinity)';
      } else {
        elLpVal.textContent    = 'â€”';
        elDistHint.textContent = '';
      }

      if (fom > sessionPeak) {
        sessionPeak = fom;
        elPeak.textContent = fom.toLocaleString();
        btnMark.disabled = false;
      }
    }

    function startPolling() {
      if (pollTimer) return;
      pollTimer = setInterval(poll, 300);   // 300 ms â‰ˆ 3 Hz, light on the Pi
      btnStart.disabled = true;
      btnStop.disabled  = false;
      poll();  // immediate first sample
    }

    function stopPolling() {
      clearInterval(pollTimer);
      pollTimer = null;
      btnStart.disabled = false;
      btnStop.disabled  = true;
    }

    btnStart.addEventListener('click', startPolling);
    btnStop.addEventListener('click',  stopPolling);

    btnReset.addEventListener('click', () => {
      sessionPeak = 0;
      elPeak.textContent  = 'â€”';
      btnMark.disabled    = true;
      elMarkNote.style.display = 'none';
      elBar.style.width   = '0%';
      elFomVal.textContent = 'â€”';
    });

    btnMark.addEventListener('click', () => {
      const lp  = parseFloat(elLpVal.textContent);
      const dist = lp > 0 ? Math.round(100 / lp) : null;
      const msg = dist
        ? `ğŸ“Œ Working distance marked at â‰ˆ ${dist} cm (LP ${lp.toFixed(1)}). Place your receipt platform at this height.`
        : `ğŸ“Œ Session peak FocusFoM ${sessionPeak.toLocaleString()} marked. Confirm exact distance with a ruler.`;
      elMarkNote.textContent      = msg;
      elMarkNote.style.display    = 'block';
      // Also show a toast if the dashboard toast system is available
      if (typeof window.showToast === 'function') {
        window.showToast(msg, 'success');
      }
    });

    // Auto-start polling when Vision Modal opens
    const visionModal = document.getElementById('modal-vision');
    if (visionModal) {
      const observer = new MutationObserver(() => {
        if (visionModal.open && details.open) startPolling();
        if (!visionModal.open) stopPolling();
      });
      observer.observe(visionModal, { attributes: true, attributeFilter: ['open'] });
    }
  }());
  // â”€â”€ /Focus Finder controller â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>

  <!-- OCR Scanner Modal -->
  <dialog id="ocr-scanner-modal" class="linear-modal" aria-labelledby="ocr-modal-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-container ocr-modal-container">
        <header class="modal-header">
            <h2 id="ocr-modal-title" class="modal-title">Flash Express Receipt Scanner</h2>
            <div class="modal-actions">
                <button id="btn-ocr-close" class="btn-ghost btn-icon-only" aria-label="Close scanner">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </header>

        <nav class="scanner-tabs" role="tablist" aria-label="Input method selection">
            <button role="tab" aria-selected="true" aria-controls="tab-camera" id="btn-tab-camera" data-tab="camera" tabindex="0" class="tab-button touch-target">
                <span class="tab-icon">ğŸ“¹</span>
                <span class="tab-label">Live Camera</span>
            </button>
            <button role="tab" aria-selected="false" aria-controls="tab-upload" id="btn-tab-upload" data-tab="upload" tabindex="-1" class="tab-button touch-target">
                <span class="tab-icon">ğŸ“¤</span>
                <span class="tab-label">Upload File</span>
            </button>
            <button role="tab" aria-selected="false" aria-controls="tab-paste" id="btn-tab-paste" data-tab="paste" tabindex="-1" class="tab-button touch-target">
                <span class="tab-icon">ğŸ“‹</span>
                <span class="tab-label">Paste Image</span>
            </button>
        </nav>

        <div class="modal-body ocr-modal-body">
            <!-- Camera Tab -->
            <div id="tab-camera" class="tab-panel active" role="tabpanel" aria-labelledby="btn-tab-camera">
                <!-- Autoâ€‘detection controls -->
                <div class="auto-detect-controls" style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;">
                    <label class="toggle-switch" style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="checkbox" id="auto-detect-toggle" style="width:1.1rem;height:1.1rem;">
                        <span class="toggle-label" style="font-size:0.85rem;">Autoâ€‘detect Receipt</span>
                    </label>
                    <span id="auto-detect-status" class="status-dot" style="width:8px;height:8px;border-radius:50%;background:#555;transition:background 0.2s;"></span>
                </div>

                <!-- Stream quality selector -->
                <div class="quality-selector" style="display:flex;align-items:center;gap:0.75rem;padding-bottom:0.5rem;font-size:0.8rem;">
                    <span class="quality-label" style="color:var(--text-secondary,#aaa);">Quality:</span>
                    <label style="display:flex;align-items:center;gap:0.25rem;cursor:pointer;"><input type="radio" name="ocr-quality" id="quality-low" value="40"> Low</label>
                    <label style="display:flex;align-items:center;gap:0.25rem;cursor:pointer;"><input type="radio" name="ocr-quality" id="quality-medium" value="70" checked> Medium</label>
                    <label style="display:flex;align-items:center;gap:0.25rem;cursor:pointer;"><input type="radio" name="ocr-quality" id="quality-high" value="95"> High</label>
                </div>

                <!-- Autoâ€‘capture preview (initially hidden) -->
                <div id="auto-capture-preview" class="hidden" style="margin-bottom:0.5rem;padding:0.5rem;border:1px solid var(--border-light,#333);border-radius:6px;font-size:0.8rem;">
                    <strong>Latest Autoâ€‘Capture</strong>
                    <a id="auto-capture-view" href="#" target="_blank" style="display:block;margin-top:0.25rem;">
                        <img id="auto-capture-img" src="" alt="Autoâ€‘captured receipt" style="max-width:100%;border-radius:4px;">
                    </a>
                    <p id="auto-capture-timestamp" style="margin-top:0.25rem;color:var(--text-secondary,#aaa);"></p>
                </div>

                <div class="stream-container">
                    <img id="ocr-stream" class="stream-image" alt="Live camera feed for document scanning" crossorigin="anonymous"/>
                    <div class="stream-overlay">
                        <div class="overlay-frame">
                            <div class="frame-guide"></div>
                        </div>
                    </div>
                    <div class="error-state hidden" aria-live="assertive">
                        <div class="error-icon" aria-hidden="true">âš ï¸</div>
                        <div class="error-message">Camera stream unavailable</div>
                    </div>
                </div>
                <div class="capture-controls">
                    <button id="btn-ocr-capture" class="btn-primary touch-target" aria-label="Capture current frame">
                        <span class="btn-icon">ğŸ“¸</span>
                        <span class="btn-text">Capture Frame</span>
                    </button>
                </div>
            </div>

            <!-- UPLOAD TAB -->
            <div id="tab-upload" class="tab-panel hidden" role="tabpanel" aria-labelledby="btn-tab-upload">
                <label for="ocr-file-input" class="file-dropzone touch-target" tabindex="0" aria-label="Drag and drop image files or click to browse">
                    <input type="file" id="ocr-file-input" accept="image/*, .jpg, .jpeg, .png, .webp" multiple style="display: none;">
                    <div class="dropzone-content">
                        <div class="dropzone-icon">ğŸ“</div>
                        <p class="dropzone-text">Drag & drop images here</p>
                        <p class="dropzone-subtext">or click to browse (multiple allowed)</p>
                        <p class="dropzone-hint">Supported: JPG, PNG, WEBP (max 5MB each, up to 10 files)</p>
                    </div>
                </label>

                <div id="upload-preview-container" class="preview-container hidden">
                    <div class="preview-header">
                        <h4>Preview</h4>
                        <button id="btn-clear-upload" class="btn-ghost btn-icon-only touch-target" aria-label="Clear uploaded image">âœ•</button>
                    </div>
                    <img id="upload-preview-img" src="" alt="Uploaded document preview" class="preview-image">
                </div>

                <div id="batch-file-list" class="batch-file-list hidden">
                    <h4>Selected Files</h4>
                    <ul id="file-list" class="file-list"></ul>
                </div>
            </div>

            <!-- Paste Tab -->
            <div id="tab-paste" class="tab-panel hidden" role="tabpanel" aria-labelledby="btn-tab-paste">
                <div class="paste-dropzone touch-target" id="paste-dropzone" tabindex="0" aria-label="Paste image from clipboard">
                    <div class="paste-content">
                        <div class="paste-icon">ğŸ“‹</div>
                        <p class="paste-text">Press Ctrl+V or Cmd+V to paste image</p>
                        <p class="paste-subtext">or click here and paste</p>
                        <p class="paste-hint">Works with screenshots and copied images</p>
                    </div>
                </div>
                <div id="paste-preview-container" class="preview-container hidden">
                    <div class="preview-header">
                        <h4>Pasted Image</h4>
                        <button id="btn-clear-paste" class="btn-ghost btn-icon-only touch-target" aria-label="Clear pasted image">âœ•</button>
                    </div>
                    <img id="paste-preview-img" src="" alt="Pasted image preview" class="preview-image">
                </div>
            </div>
        </div>

        <footer class="modal-footer ocr-modal-footer">
            <div class="action-controls">
                <button id="btn-analyze" class="btn-primary touch-target" disabled aria-label="Analyze document">
                    <span class="btn-icon">ğŸ”</span>
                    <span class="btn-text">Analyze Receipt</span>
                </button>
                <button id="btn-batch-upload" class="btn-secondary touch-target" disabled aria-label="Upload all selected images">
                    <span class="btn-icon">ğŸ“¤</span>
                    <span class="btn-text">Upload All (Batch)</span>
                </button>
                <button id="btn-clear-all" class="btn-secondary touch-target" aria-label="Clear all and start over">
                    <span class="btn-icon">ğŸ”„</span>
                    <span>Clear</span>
                </button>
            </div>

            <div id="ocr-results-panel" class="results-panel hidden" aria-live="polite">
                <div class="results-header">
                    <h3 class="results-title">Flash Express Receipt Scan</h3>
                    <div class="confidence-indicator">
                        <span class="confidence-dot" id="confidence-dot"></span>
                        <span class="confidence-text" id="confidence-value">--%</span>
                    </div>
                </div>
                
                <div class="results-grid">
                    <div class="result-field">
                        <label class="field-label">Tracking ID</label>
                        <div class="field-value" id="result-tracking-id">-</div>
                        <button class="btn-copy touch-target" data-field="tracking-id" aria-label="Copy tracking ID">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Order ID</label>
                        <div class="field-value" id="result-order-id">-</div>
                        <button class="btn-copy touch-target" data-field="order-id" aria-label="Copy order ID">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">RTS Code</label>
                        <div class="field-value" id="result-rts-code">-</div>
                        <button class="btn-copy touch-target" data-field="rts-code" aria-label="Copy RTS code">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Rider ID</label>
                        <div class="field-value" id="result-rider-id">-</div>
                        <button class="btn-copy touch-target" data-field="rider-id" aria-label="Copy rider ID">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Buyer Name</label>
                        <div class="field-value" id="result-buyer-name">-</div>
                        <button class="btn-copy touch-target" data-field="buyer-name" aria-label="Copy buyer name">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Buyer Address</label>
                        <div class="field-value" id="result-buyer-address">-</div>
                        <button class="btn-copy touch-target" data-field="buyer-address" aria-label="Copy buyer address">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Weight</label>
                        <div class="field-value" id="result-weight">-</div>
                        <button class="btn-copy touch-target" data-field="weight" aria-label="Copy weight">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Quantity</label>
                        <div class="field-value" id="result-quantity">-</div>
                        <button class="btn-copy touch-target" data-field="quantity" aria-label="Copy quantity">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Payment Type</label>
                        <div class="field-value" id="result-payment-type">-</div>
                        <button class="btn-copy touch-target" data-field="payment-type" aria-label="Copy payment type">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field">
                        <label class="field-label">Confidence</label>
                        <div class="field-value" id="result-confidence-display">-</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidence-fill"></div>
                        </div>
                    </div>
                    <div class="result-field full-width">
                        <label class="field-label">Timestamp</label>
                        <div class="field-value" id="result-timestamp">-</div>
                        <button class="btn-copy touch-target" data-field="timestamp" aria-label="Copy timestamp">
                            <span class="copy-icon">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="result-field full-width">
                        <label class="field-label">OCR Engine</label>
                        <div class="field-value" id="result-engine">-</div>
                        <div class="processing-info" id="processing-time">-</div>
                    </div>
                </div>
                
                <div class="results-actions">
                    <button id="btn-save-scan" class="btn-secondary touch-target">
                        <span class="btn-icon">ğŸ’¾</span>
                        <span>Save to Database</span>
                    </button>
                    <button id="btn-export-json" class="btn-ghost touch-target">
                        <span class="btn-icon">ğŸ“¥</span>
                        <span>Export JSON</span>
                    </button>
                </div>
            </div>
        </footer>

        <!-- BATCH RESULTS CONTAINER -->
        <div id="batch-results-container" class="batch-results-container" role="region" aria-label="Batch OCR Results">
          <div class="batch-results-header">
            <h3 class="batch-results-title">Batch Results</h3>
            <button id="btn-close-batch" class="btn-icon" aria-label="Close batch results">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
              </svg>
            </button>
          </div>
          
          <div id="batch-results-grid" class="batch-results-grid">
            <!-- Dynamic cards generated here -->
          </div>
        </div>

    </div>
  </dialog>

  <!-- Motor Control Modal -->
  <dialog id="controlModal" class="linear-modal" aria-labelledby="modal-control-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <header class="modal-header">
        <h2 id="modal-control-title" class="modal-title">Motor Control</h2>
        <div class="modal-actions">
          <button id="btn-control-close" class="btn-ghost btn-icon-only" aria-label="Close control panel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </header>
      <div class="modal-body">
        <div class="control-panel">
          <div class="control-group">
            <label for="speed-slider">Speed</label>
            <input type="range" id="speed-slider" min="0" max="100" value="50" class="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50">
            <span id="speed-value" aria-hidden="true">50%</span>
          </div>
          <div id="direction-pad" class="d-pad" role="group" aria-label="Directional Controls">
            <button class="dir-btn" data-dir="forward" aria-label="Move forward">â†‘</button>
            <button class="dir-btn" data-dir="left" aria-label="Turn left">â†</button>
            <button class="dir-btn" data-dir="stop" aria-label="Stop motors">â—</button>
            <button class="dir-btn" data-dir="right" aria-label="Turn right">â†’</button>
            <button class="dir-btn" data-dir="backward" aria-label="Move backward">â†“</button>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <button id="apply-controls" class="btn-primary">Apply</button>
      </footer>
    </div>
  </dialog>

  <!-- LiDAR Modal -->
  <dialog id="modal-lidar" class="linear-modal" aria-labelledby="modal-lidar-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <header class="modal-header">
        <h2 id="modal-lidar-title" class="modal-title">LiDAR Visualization</h2>
        <div class="status-indicator" id="lidar-modal-status" data-status="offline" aria-live="polite">
          <span class="status-dot"></span>
          <span class="status-text">Offline</span>
        </div>
        <div class="modal-actions">
          <button id="btn-lidar-start" class="btn-primary" aria-label="Start LiDAR scanning">
            <span class="btn-icon">â–¶</span>
            <span class="btn-text">Start</span>
          </button>
          <button id="btn-lidar-stop" class="btn-secondary" disabled aria-label="Stop LiDAR scanning">
            <span class="btn-icon">â¹</span>
            <span class="btn-text">Stop</span>
          </button>
          <button id="btn-lidar-close" class="btn-ghost btn-icon-only" aria-label="Close LiDAR panel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </header>
      <div class="modal-body">
        <div class="lidar-canvas-container">
          <canvas id="lidar-canvas" width="500" height="500" style="width:100%;height:auto;aspect-ratio:1/1;background:var(--bg-surface);border-radius:8px;"></canvas>
          <div class="error-state hidden" aria-live="assertive">
            <div class="error-icon" aria-hidden="true">âš ï¸</div>
            <div class="error-message">LiDAR unavailable</div>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <div class="info-text" id="lidar-info">Not connected</div>
      </footer>
    </div>
  </dialog>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="toast-container" aria-live="polite"></div>

  <script src="/static/js/ocr-panel.js"></script>
  <script src="/static/js/lidar-panel.js"></script>
  <script src="/static/js/dashboard-core.js"></script>
</body>
</html>